<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pillow Control</title>
    <script src="mqtt.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-weight: bold;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .message-log {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 14px;
      }
      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
      .log-entry.received {
        color: #007bff;
      }
      .log-entry.sent {
        color: #28a745;
      }
      .log-entry.error {
        color: #dc3545;
      }
      .log-entry.info {
        color: #6c757d;
      }
      .payload-selector {
        margin: 15px 0;
        padding: 10px;
        background-color: #f0f8ff;
        border-radius: 5px;
      }
      .payload-option {
        display: inline-block;
        margin-right: 10px;
        padding: 5px 10px;
        background-color: #e9ecef;
        border-radius: 3px;
        cursor: pointer;
        border: 1px solid transparent;
      }
      .payload-option.selected {
        background-color: #4CAF50;
        color: white;
        border-color: #388e3c;
      }
      .payload-option:hover {
        background-color: #d0d7dd;
      }
      
      /* 枕头可视化样式 - 紧凑版本 */
      .pillow-container {
        display: flex;
        margin: 30px 0;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 10px;
        border: 1px solid #ddd;
      }
      .pillow-visualization {
        flex: 1;
      }
      .pillow-status {
        flex: 0 0 200px;
        padding-left: 20px;
        border-left: 1px solid #ddd;
      }
      .pillow-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        text-align: center;
        color: #333;
      }
      .layer-container {
        margin-bottom: 20px;
      }
      .layer-title {
        font-size: 14px;
        margin-bottom: 8px;
        color: #555;
        font-weight: bold;
      }
      /* 第二层在上方 - 气囊层 */
      .layer2-container {
        margin-bottom: 25px;
      }
      .airbag-row {
        display: flex;
        align-items: flex-end;
        height: 40px;
        margin-bottom: 5px;
      }
      .airbag-block {
        flex: 1;
        margin: 0 2px;
        background-color: #4a9eff;
        border: 1px solid #2a7eff;
        border-radius: 2px;
        transition: height 0.5s;
        min-height: 5px;
      }
      /* 修改：气囊标签横向排列 */
      .airbag-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 3px;
      }
      .airbag-label {
        flex: 1;
        text-align: center;
        font-size: 10px;
        color: #555;
        margin: 0 2px;
      }
      /* 第一层在下方 - 压力层 */
      .layer1-container {
        margin-bottom: 15px;
      }
      .pressure-row {
        display: flex;
        height: 30px;
        margin-bottom: 5px;
      }
      .pressure-block {
        flex: 1;
        margin: 0 1px;
        border: 1px solid #ccc;
        border-radius: 2px;
        background-color: #f0f0f0;
        transition: background-color 0.3s;
        position: relative;
      }
      .pressure-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 9px;
        color: #333;
        font-weight: bold;
        display: block;
      }
      /* 状态指示区域 - 响应式布局 */
      .status-indicators {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
      }
      .status-item {
        flex: 1;
        min-width: 120px;
        margin-bottom: 10px;
      }
      .status-label {
        font-size: 13px;
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }
      .snore-light {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        border: 2px solid #ccc;
        background-color: #f0f0f0;
        transition: background-color 0.3s;
        margin-top: 3px;
      }
      .snore-light.active {
        background-color: #ff4444;
        box-shadow: 0 0 8px #ff4444;
      }
      .device-status-light {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        border: 2px solid #ccc;
        background-color: #f0f0f0;
        transition: background-color 0.3s;
        margin-top: 3px;
      }
      .device-status-light.online {
        background-color: #4CAF50;
        box-shadow: 0 0 8px #4CAF50;
      }
      .device-status-light.offline {
        background-color: #f0f0f0;
      }
      .scheme-display {
        padding: 8px;
        border-radius: 4px;
        background-color: #e8f5e9;
        border: 1px solid #c8e6c9;
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        color: #2e7d32;
        opacity: 0;
        transition: opacity 0.3s;
        min-width: 80px;
      }
      .scheme-display.visible {
        opacity: 1;
      }
      .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      .controls button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      #connectButton {
        background-color: #4CAF50;
        color: white;
      }
      #connectButton:hover {
        background-color: #45a049;
      }
      #connectButton:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #disconnectButton {
        background-color: #f44336;
        color: white;
      }
      #disconnectButton:hover {
        background-color: #d32f2f;
      }
      #disconnectButton:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      #publishButton {
        background-color: #2196F3;
        color: white;
      }
      #publishButton:hover {
        background-color: #1976D2;
      }
      #publishButton:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      
      /* 响应式设计 */
      @media (max-width: 768px) {
        .pillow-container {
          flex-direction: column;
        }
        .pillow-status {
          flex: none;
          width: 100%;
          padding-left: 0;
          border-left: none;
          border-top: 1px solid #ddd;
          padding-top: 20px;
          margin-top: 20px;
        }
        .status-indicators {
          flex-direction: column;
        }
        .status-item {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 注释掉连接信息区域 -->
      <!--
      <div class="connection-info">
        <h3>Connection Information</h3>
        <div class="info-item">
          <span class="info-label">WSS Address:</span>
          <span id="wssAddress">wss://broker.emqx.io:8084/mqtt</span>
        </div>
        <div class="info-item">
          <span class="info-label">Client ID:</span>
          <span id="clientIdDisplay">Not set</span>
        </div>
        <div class="info-item">
          <span class="info-label">Username:</span>
          <span id="usernameDisplay">Not set</span>
        </div>
        <div class="info-item">
          <span class="info-label">Topic:</span>
          <span id="topicDisplay">pillow/[clientId]/ctrl</span>
        </div>
      </div>
      -->
      
      <!-- 枕头可视化区域 -->
      <div class="pillow-container">
        <div class="pillow-visualization">
          <div class="pillow-title">智能枕头状态监控</div>
          
          <!-- 第二层在上方：气囊状态层 -->
          <div class="layer-container layer2-container">
            <div class="layer-title">第二层：气囊状态 (6个气囊)</div>
            <div class="airbag-row" id="airbagRow">
              <!-- 6个气囊块将通过JavaScript动态生成 -->
            </div>
            <!-- 修改：气囊标签横向排列 -->
            <div class="airbag-labels" id="airbagLabels">
              <!-- 气囊标签将通过JavaScript动态生成 -->
            </div>
          </div>
          
          <!-- 第一层在下方：压力探测层 -->
          <div class="layer-container layer1-container">
            <div class="layer-title">第一层：压力探测 (16个区域)</div>
            <div class="pressure-row" id="pressureRow">
              <!-- 16个压力块将通过JavaScript动态生成 -->
            </div>
          </div>
        </div>
        
        <div class="pillow-status">
          <div class="pillow-title">状态指示</div>
          
          <div class="status-indicators">
            <!-- 设备在线状态 -->
            <div class="status-item">
              <div class="status-label">设备状态</div>
              <div class="device-status-light offline" id="deviceStatusLight"></div>
              <div style="font-size: 11px; margin-top: 3px;">
                <span id="deviceStatusText">离线</span>
              </div>
            </div>
            
            <!-- 鼾声检测 -->
            <div class="status-item">
              <div class="status-label">鼾声检测</div>
              <div class="snore-light" id="snoreLight"></div>
              <div style="font-size: 11px; margin-top: 3px;">
                <span id="snoreStatusText">未检测到鼾声</span>
              </div>
            </div>
            
            <!-- 当前方案 -->
            <div class="status-item">
              <div class="status-label">当前方案</div>
              <div class="scheme-display" id="schemeDisplay">
                方案: <span id="schemeValue">-</span><span id="schemeAction"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="payload-selector">
        <strong>选择消息类型:</strong>
        <div id="payloadOptions">
          <!-- Payload options will be generated by JavaScript -->
        </div>
        <!-- 移除了"Selected:"提示行 -->
      </div>

      <div id="statusContainer" class="status disconnected">
        Status: Disconnected
      </div>

      <div class="controls">
        <button id="connectButton" onclick="connectToBroker()">Connect</button>
        <button id="disconnectButton" onclick="disconnectFromBroker()" disabled>Disconnect</button>
        <button id="publishButton" onclick="publishMessage()" disabled>Publish Message</button>
      </div>

      <div class="message-log">
        <h4>Message Log</h4>
        <div id="messageLog"></div>
      </div>
    </div>

    <script>
      // MQTT client variable
      let client = null;
      let selectedPayload = 'p'; // Default payload
      const payloadOptions = [
        { value: 'p', label: '压力' },
        { value: 'b', label: '气囊' },
        { value: 't', label: '时间' },
        //{ value: 'r', label: '重启' },
        //{ value: 'i', label: '打气' },
        { value: 'l', label: '放气' }
      ];
      
      // 枕头状态数据
      let pressureValues = Array(16).fill(-3); // 16个压力值，初始为无压力(-3)
      let airbagValues = Array(6).fill(0); // 6个气囊状态值
      let snoreStatus = 0; // 鼾声检测状态: 0=关闭, 1=开启
      let currentScheme = -1; // 当前执行方案
      let deviceOnline = false; // 设备在线状态
	  let deviceTimeSync = false;
      
      // Function to parse URL parameters
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          clientId: params.get('clientId') || 'm_NOCLIENT',
          username: params.get('username') || 'emqx_test',
          password: params.get('password') || 'emqx_test',
          connectUrl: params.get('connectUrl') || 'wss://broker.emqx.io:8084/mqtt'
        };
      }
      
      // Function to create payload selector options
      function createPayloadSelector() {
        const container = document.getElementById('payloadOptions');
        payloadOptions.forEach(payload => {
          const option = document.createElement('div');
          option.className = `payload-option ${payload.value === selectedPayload ? 'selected' : ''}`;
          option.textContent = payload.label;
          option.onclick = () => {
            selectedPayload = payload.value;
            
            // Update selected state
            document.querySelectorAll('.payload-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            option.classList.add('selected');
          };
          container.appendChild(option);
        });
      }
      
      // 创建枕头可视化元素
      function createPillowVisualization() {
        // 创建第二层：6个气囊块
        const airbagRow = document.getElementById('airbagRow');
        const airbagLabels = document.getElementById('airbagLabels');
        airbagRow.innerHTML = '';
        airbagLabels.innerHTML = '';
        
        for (let i = 0; i < 6; i++) {
          // 气囊块
          const block = document.createElement('div');
          block.className = 'airbag-block';
          block.id = `airbag-block-${i}`;
          block.style.height = '5px'; // 默认高度（0%）
          airbagRow.appendChild(block);
          
          // 气囊标签（横排显示）
          const label = document.createElement('div');
          label.className = 'airbag-label';
          label.textContent = `A${i+1}`;
          airbagLabels.appendChild(label);
        }
        
        // 创建第一层：16个压力块
        const pressureRow = document.getElementById('pressureRow');
        pressureRow.innerHTML = '';
        
        for (let i = 0; i < 16; i++) {
          const block = document.createElement('div');
          block.className = 'pressure-block';
          block.id = `pressure-block-${i}`;
          block.innerHTML = `<div class="pressure-value">${i}: ${pressureValues[i] === -3 ? '无' : pressureValues[i]}</div>`;
          
          // 根据初始状态设置颜色
          updatePressureBlock(i, pressureValues[i]);
          
          pressureRow.appendChild(block);
        }
        
        // 初始化鼾声检测灯
        updateSnoreLight();
        
        // 初始化设备状态
        updateDeviceStatus();
        
        // 初始化方案显示
        updateSchemeDisplay();
      }
      
      // 重置所有压力块为无压力状态
      function resetAllPressureBlocks() {
        for (let i = 0; i < 16; i++) {
          pressureValues[i] = -3; // -3 表示无压力
          updatePressureBlock(i, -3);
        }
      }
      
      // 根据压力值获取颜色
      function getPressureColor(value) {
        if (value === -1) return '#ff4444'; // 异常 (po)
        if (value === -2) return '#ffa500'; // 过载 (ph)
        if (value === -3) return '#f0f0f0'; // 无压力 (pl)
        
        // 正常压力值：0-4096，按压力大小显示不同颜色深度
        const normalized = Math.min(value / 4096, 1);
        
        if (normalized < 0.3) {
          // 低压力：浅蓝色
          return `hsl(210, 80%, 75%)`;
        } else if (normalized < 0.7) {
          // 中压力：蓝色
          return `hsl(210, 80%, 55%)`;
        } else {
          // 高压力：深蓝色
          return `hsl(210, 80%, 35%)`;
        }
      }
      
      // 更新压力块显示
      function updatePressureBlock(index, value) {
        const block = document.getElementById(`pressure-block-${index}`);
        if (!block) return;
        
        const valueElement = block.querySelector('.pressure-value');
        
        if (value === -1) { // 异常
          block.style.backgroundColor = '#ff4444';
          block.style.borderColor = '#cc0000';
          valueElement.textContent = `${index}: 异常`;
          valueElement.style.color = 'white';
        } else if (value === -2) { // 过载
          block.style.backgroundColor = '#ffa500';
          block.style.borderColor = '#cc8400';
          valueElement.textContent = `${index}: 过载`;
          valueElement.style.color = 'white';
        } else if (value === -3) { // 无压力
          block.style.backgroundColor = '#f0f0f0';
          block.style.borderColor = '#ccc';
          valueElement.textContent = `${index}: 无`;
          valueElement.style.color = '#333';
        } else { // 正常压力值
          block.style.backgroundColor = getPressureColor(value);
          block.style.borderColor = '#2a7eff';
          valueElement.textContent = `${index}: ${value}`;
          valueElement.style.color = value > 2048 ? 'white' : '#333';
        }
      }
      
      // 更新气囊块显示
      function updateAirbagBlock(index, percentage) {
        const block = document.getElementById(`airbag-block-${index}`);
        if (!block) return;
        
        // 限制百分比在0-100之间
        const clampedPercentage = Math.max(0, Math.min(100, percentage));
        
        // 设置高度 (5px 到 40px 之间)
        const height = 5 + (clampedPercentage / 100) * 35;
        block.style.height = `${height}px`;
        
        // 固定颜色，不使用渐变色
        block.style.backgroundColor = '#4a9eff';
      }
      
      // 更新鼾声检测灯
      function updateSnoreLight() {
        const light = document.getElementById('snoreLight');
        const statusText = document.getElementById('snoreStatusText');
        
        if (snoreStatus === 1) {
          light.classList.add('active');
          statusText.textContent = '检测到鼾声';
          statusText.style.color = '#ff4444';
        } else {
          light.classList.remove('active');
          statusText.textContent = '未检测到鼾声';
          statusText.style.color = '#555';
        }
      }
      
      // 更新设备在线状态
      function updateDeviceStatus() {
        const light = document.getElementById('deviceStatusLight');
        const statusText = document.getElementById('deviceStatusText');
        
        if (deviceOnline) {
          light.classList.remove('offline');
          light.classList.add('online');
          statusText.textContent = '在线';
          statusText.style.color = '#4CAF50';
          if (!deviceTimeSync) {
              deviceTimeSync = true;
			  publishMessage('t=' + parseInt(new Date().getTime()/1000));
          }
        } else {
          light.classList.remove('online');
          light.classList.add('offline');
          statusText.textContent = '离线';
          statusText.style.color = '#555';
          deviceTimeSync = false;
        }
      }
      
      // 设置设备在线状态
      function setDeviceOnline(online) {
        deviceOnline = online;
        updateDeviceStatus();
        
        // 记录状态变化
        //if (online) {
          //logMessage('设备上线', 'info');
        //} else {
          //logMessage('设备下线', 'info');
        //}
      }
      
      // 更新方案显示
      function updateSchemeDisplay() {
        const display = document.getElementById('schemeDisplay');
        const valueElement = document.getElementById('schemeValue');
        const actElement = document.getElementById('schemeAction');
        
        if (currentScheme >= 0) {
          valueElement.textContent = currentScheme;
          actElement.textContent = currentAction;
          display.classList.add('visible');
        } else {
          display.classList.remove('visible');
        }
      }
      
      // 显示方案
      function showScheme(scheme, action) {
        if (scheme) {
          currentScheme = scheme;
        }
        currentAction = action || '';
        updateSchemeDisplay();
      }
      
      // Function to log messages
      function logMessage(message, type = 'info') {
        const logContainer = document.getElementById('messageLog');
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        
        const timestamp = new Date().toLocaleTimeString();
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        logContainer.appendChild(logEntry);
        
        // 自动滚动到底部
        logContainer.scrollTop = logContainer.scrollHeight;
      }
      
      // Function to update connection status
      function updateConnectionStatus(connected) {
        const statusContainer = document.getElementById('statusContainer');
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const publishButton = document.getElementById('publishButton');
        
        if (connected) {
          statusContainer.textContent = 'Status: Connected';
          statusContainer.className = 'status connected';
          connectButton.disabled = true;
          disconnectButton.disabled = false;
          publishButton.disabled = false;
          logMessage('Connected to MQTT broker', 'info');
        } else {
          statusContainer.textContent = 'Status: Disconnected';
          statusContainer.className = 'status disconnected';
          connectButton.disabled = false;
          disconnectButton.disabled = true;
          publishButton.disabled = true;
          logMessage('Disconnected from MQTT broker', 'info');
        }
      }

      // Function to connect to MQTT broker
      function connectToBroker() {
        const params = getUrlParams();
        const clientId = params.clientId;
        
        if ('m_NOCLIENT' == clientId) {
          console.log('no client, will not connect');
          logMessage('No client ID specified, will not connect', 'error');
          return;
        }
        
        const connectUrl = params.connectUrl;
        const username = params.username;
        const password = params.password;
        const subscriptionTopic = `pillow/${clientId}/#`;
        const publishTopic = `pillow/${clientId}/ctrl`;
        
        logMessage(`Connecting to: ${connectUrl}`, 'info');
        logMessage(`Client ID: ${clientId}`, 'info');
        logMessage(`Will subscribe to: ${subscriptionTopic}`, 'info');
        logMessage(`Will publish to: ${publishTopic}`, 'info');
        
        const options = {
          keepalive: 60,
          clientId: "mq_Hcli_" + Math.random().toString(16).substring(2, 8),
          clean: true,
          connectTimeout: 30 * 1000,
          username: username,
          password: password,
          reconnectPeriod: 1000,
        };
        
        console.log('Connecting MQTT client with options:', options);
        
        client = mqtt.connect(connectUrl, options);
        
        client.on('error', (err) => {
          console.log('Connection error: ', err);
          logMessage(`Connection error: ${err.message}`, 'error');
          updateConnectionStatus(false);
        });
        
        client.on('reconnect', () => {
          console.log('Reconnecting...');
          logMessage('Reconnecting to broker...', 'info');
        });

        client.on('connect', () => {
          console.log('Client connected');
          updateConnectionStatus(true);

          // Subscribe to the fixed topic
          client.subscribe(subscriptionTopic, { qos: 0 }, (error) => {
            if (error) {
              console.log('Subscribe error:', error);
              logMessage(`Subscribe error: ${error.message}`, 'error');
              return;
            }
            console.log(`Subscribed to topic ${subscriptionTopic}`);
            logMessage(`Subscribed to topic: ${subscriptionTopic}`, 'info');
          });
        });
        
        client.on('message', (topic, payload) => {
          const message = payload.toString();

          // 先输出日志
          console.log('Received Message: ' + message + ' On topic: ' + topic);
          logMessage(`Received on ${topic}: ${message}`, 'received');

          // 根据消息前缀处理不同类型的消息
          if (message === 'bye') {
            // 设备下线消息
            setDeviceOnline(false);
          } else {
            setDeviceOnline(true);
            if (message.startsWith('p')) {
              // 处理压力消息前，设置设备为在线状态
              handlePressureMessage(message);
            } else if (message.startsWith('b')) {
              // 处理气囊消息前，设置设备为在线状态
              handleAirbagMessage(message);
            } else if (message.startsWith('s')) {
              // 处理鼾声检测消息前，设置设备为在线状态
              handleSnoreMessage(message);
            } else if (message.startsWith('f')) {
              // 处理方案消息前，设置设备为在线状态
              handleSchemeMessage(message);
            } else if (message.startsWith('F')) {
              // 处理方案消息前，设置设备为在线状态
              handleSchemeMessage(message);
            //} else if (message === 'hi') {
              // 设备上线消息
            } else {
              logMessage(`消息: ${message}`, 'info');
            }
          }
        });

        // Store topic for later use
        window.publishTopic = publishTopic;
      }
      
      // 处理压力消息
      function handlePressureMessage(payload) {
        console.log(`处理压力消息: ${payload}`);
        
        if (payload === 'pl') {
          // 无压力：将所有压力块重置为无压力状态
          resetAllPressureBlocks();
        } else if (payload === 'ph') {
          // 压力过载：将所有压力块标记为过载
          for (let i = 0; i < 16; i++) {
            pressureValues[i] = -2; // -2 表示过载
            updatePressureBlock(i, -2);
          }
        } else if (payload === 'po') {
          // 压力检测异常：将所有压力块标记为异常
          for (let i = 0; i < 16; i++) {
            pressureValues[i] = -1; // -1 表示异常
            updatePressureBlock(i, -1);
          }
        } else if (payload.startsWith('p')) {
          // 格式: p_A_B_C_D_E_...，A,B...是压力值(0-4096)
          const parts = payload.substring(2).split('_');
          if (parts.length === 16) {
            const position = parseInt(parts[0]);
            const value = parseInt(parts[1]);
            for (let i = 0; i < 16; i++) {
                const parseVal = parseInt(parts[i]);
                pressureValues[i] = parseVal;
                updatePressureBlock(i, parseVal);
            }
          }
        }
      }
      
      // 处理气囊消息
      function handleAirbagMessage(payload) {
        console.log(`处理气囊消息: ${payload}`);
        
        if (payload.startsWith('b')) {
          // 格式: b_A_B_C_D_E_F，其中A-F是6个气囊的百分比值(0-100)
          const parts = payload.substring(2).split('_');
          if (parts.length === 6) {
            for (let i = 0; i < 6; i++) {
              const percentage = parseInt(parts[i]);
              if (!isNaN(percentage) && percentage >= 0 && percentage <= 100) {
                airbagValues[i] = percentage;
                updateAirbagBlock(i, percentage);
              }
            }
          }
        }
      }
      
      // 处理鼾声检测消息
      function handleSnoreMessage(payload) {
        console.log(`处理鼾声消息: ${payload}`);
        
        if (payload === 's0') {
          snoreStatus = 0;
        } else if (payload === 's1') {
          snoreStatus = 1;
        }
        
        updateSnoreLight();
      }
      
      // 处理方案消息
      function handleSchemeMessage(payload) {
        console.log(`处理方案消息: ${payload}`);

        if (payload.startsWith('f')) {
          const scheme = parseInt(payload.substring(1));
          if (!isNaN(scheme) && scheme >= 0 && scheme <= 255) {
            showScheme(scheme);
          }
        } else if (payload.startsWith('F')) {
			showScheme(-1);
        } 
        if (payload.startsWith('m')) {
          const action = parseInt(payload.substring(1));
            showScheme(null, action);
        } else if (payload.startsWith('M')) {
			showScheme(null, null);
        }
      }
      
      // Function to publish a message
      function publishMessage(setParam) {
        if (!client || !client.connected) {
          logMessage('Cannot publish: Not connected', 'error');
          return;
        }
        
        const topic = window.publishTopic;
        const payload = setParam || selectedPayload;
        const qos = 0;
        
        client.publish(topic, payload, { qos }, (error) => {
          if (error) {
            console.error(error);
            logMessage(`Publish error: ${error.message}`, 'error');
          } else {
            console.log(`Published ${payload} to ${topic}`);
            logMessage(`Published to ${topic}: ${payload}`, 'sent');
          }
        });
      }
      
      // Function to disconnect from broker
      function disconnectFromBroker() {
        if (client && client.connected) {
          try {
            client.end(false, () => {
              console.log('Disconnected successfully');
              logMessage('Disconnected from broker', 'info');
              updateConnectionStatus(false);
            });
          } catch (error) {
            console.log('Disconnect error:', error);
            logMessage(`Disconnect error: ${error.message}`, 'error');
          }
        }
      }
      
      // Initialize the page
      function initPage() {
        const params = getUrlParams();
        createPayloadSelector();
        createPillowVisualization();
        logMessage('Page initialized. Click "Connect" to start.', 'info');
      }
      
      // Initialize when page loads
      window.onload = initPage;
      
      // Handle page unload
      window.onbeforeunload = function() {
        if (client && client.connected) {
          client.end();
        }
      };
    </script>
  </body>
</html>
